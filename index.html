<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gretta</title>
    <meta name="description" content="Coding Assistant Developed by Golden Apple Technologies, powered by Google. Your All in all Chatbot that helps in code de debugging, code generation, explanation and more in a way that a Developer will not have to visit much Platforms to meet their needs.">
    <meta name="keywords" content="Gretta, Meta, GPT, OpenAI, unrestricted, Golden Apple Technologies, Luna, TumCode, Icii White, Best, AI, Chatbot">
    <meta property="og:title" content="Gretta">
    <meta property="og:description" content="Coding Assistant Developed by Golden Apple Technologies, powered by Google. Your All in all Chatbot that helps in code de debugging, code generation, explanation and more in a way that a Developer will not have to visit much Platforms to meet their needs.">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://iciiwhite.github.io/gretta">
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="Gretta">
    <meta name="twitter:description" content="Coding Assistant Developed by Golden Apple Technologies, powered by Google. Your All in all Chatbot that helps in code de debugging, code generation, explanation and more in a way that a Developer will not have to visit much Platforms to meet their needs.">
    <meta name="robots" content="index, follow">
    <meta name="author" content="Icii White üíù">
    <link rel="canonical" href="https://iciiwhite.github.io/gretta">
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "Article",
      "headline": "Gretta",
      "description": "Coding Assistant Developed by Golden Apple Technologies, powered by Google. Your All in all Chatbot that helps in code de debugging, code generation, explanation and more in a way that a Developer will not have to visit much Platforms to meet their needs.",
      "author": {
        "@type": "Person",
        "name": "Icii White üíù"
      },
      "publisher": {
        "@type": "Organization",
        "name": "Golden Apple Technologies",
        "logo": {
          "@type": "ImageObject",
          "url": "favicon.ico"
        }
      },
      "datePublished": "2025-11-24",
      "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "https://iciiwhite.github.io/gretta"
      }
    }
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --auto: auto;
            --one: #ffb300;
        }
        html {
            font-family: Arial, sans-serif;
        }
        #grettaLogo {
            width: 2em;
            height: auto;
            padding: 0;
            margin: 0.2em;
            border-radius: 7em;
            border: 5px solid black;
            background: black;
            position: fixed;
            top: 0.7em;
        }
        #bars {
            width: 2em;
            height: auto;
            padding: 0;
            margin: 0.2em;
            border-radius: 0.6em;
            border: 5px solid black;
            background: black;
            position: fixed;
            top: 0.7em;
            right: 0.7em;
        }
        
        .voice{
            width: 1.6em;
            height: auto;
            padding: 0;
            margin: 0.2em;
            border-radius: 90em;
            border: 5px solid black;
            background: black;
           
        }
        #newChatBtn{
            width: 2em;
            height: auto;
            padding: 0;
            margin: 0.2em;
            border-radius: 0.6em;
            border: 5px solid black;
            background: black;
            position: fixed;
            top: 0.7em;
            right: 5em;
        }
        #header {
            background: var(--one);
            position: fixed;
            width: 100%;
            top: 0;
            left: 0;
            border-bottom: 5px solid black;
            z-index: 1000;
        }
        #logo {
            font-size: 1.8em;
            padding-left: 1.6em;
            font-weight: 900;
        }
        #messageArea {
            width: 100%;
            margin-left: 0;
            padding-left: 0;
            background: white;
            top: 0;
            left: 0;
            padding-bottom: 70px;
            padding-top: 30px;
        }
        #inputArea {
            background: var(--one);
            position: fixed;
            width: 100%;
            bottom: 0;
            left: 0;
            border-top: 5px solid black;
            z-index: 1000;
        }
        .input-container {
            display: flex;
            padding: 10px;
            align-items: center;
            position: relative;
        }
        .input-container:focus-within {
            border-color: red;
            box-shadow: 0 0 0 2px rgba(108, 99, 255, 0.2);
        }
        .chat-input {
            flex: 1;
            font-family: Arial, sans-serif;
            padding: 15px;
            border: none;
            background: black;
            border-radius: 90em;
            color: white;
            font-size: 1rem;
            outline: none;
            resize: none;
            height: 25px;
            max-height: 150px;
            font-weight: bolder;
            overflow-y: auto;
        }
        #logoSpan {
            color: white;
        }
        .chat-input::placeholder {
            color: gray;
        }
        .input-actions {
            display: flex;
            gap: 0;
            margin-left: 10px;
        }
        .input-action-btn {
            background: black;
            border: none;
            border-radius: 90em;
            color: white;
            cursor: pointer;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            font-size: 1.5em;
            justify-content: center;
        }
        .send-btn {
            width: 50px;
            height: 50px;
            border-radius: 90em;
            font-size: 2em;
            background: black;
            border: none;
            color: white;
            margin-left: 2px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .send-btn:hover:not(:disabled) {
            border: 1px solid white;
            transform: scale(1.05);
        }
        .send-btn:disabled {
            background: rgba(255, 255, 255, 0.2);
            cursor: not-allowed;
            opacity: 0.6;
        }
        .test {
            width: 100%;
            height: 20em; 
            background: black;
            color: white;
        }
        #menuActions {
            background: var(--one);
            border: 5px solid black;
            color: black;
            text-transform: uppercase;
            border-radius: 3em;
            font-weight: 900;
        }
        th {
            border: none;
            color: white;
        }
        #rates1, #rates2, #rates3, #rates4, #rates5 {
            display: none;
            color: yellow;
            text-outline: black;
        }
        #rate1, #rate2, #rate3, #rate4, #rate5 {
            color: gray;
        }
        
        /* Chat message styles */
        .message {
            max-width: 80%;
            margin: 0.3em 2px;
            padding: 12px 15px;
            border-radius: 18px;
            word-wrap: break-word;
            position: relative;
        }
        .user-message {
            background: var(--one);
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 5px;
        }
        .ai-message {
            background: black;
            color: white;
            margin-right: auto;
            border-bottom-left-radius: 5px;
        }
        .welcome-message{
        background: none;
        color: black;
        font-weight: bolder;
        text-align: center;
        font-size: 3em;
        opacity: 0.5;
              
        }
        .ai-message img {
            max-width: 100%;
            border-radius: 10px;
            margin: 10px 0;
            border: 0px solid #444;
        }
        .ai-message table{width: 100%;
        border: 1px solid gray;}
        .ai-message table, .ai-message th, .ai-message td{
              border: 1px solid gray;
              border-collapse: collapse;
        }
        .code-block {
            background: #111;
            border: 1px solid white;
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
            position: relative;
            font-family: monospace;
            overflow-x: auto;
        }
        .copy-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: #333;
            color: white;
            border: none;
            border-radius: 3px;
            padding: 3px 8px;
            cursor: pointer;
            font-size: 0.8em;
        }
        .message-actions {
            display: flex;
            justify-content: flex-end;
            margin-top: 8px;
            gap: 10px;
        }
        .message-action-btn {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 0.9em;
        }
        .message-action-btn:hover {
            opacity: 0.8;
        }
        
        /* Menu styles */
        #chatsTab, #settingsTab {
            padding: 10px;
            color: black;
        }
        .chat-history-item {
            padding: 10px;
            margin: 2px 0;
            background: var(--one);
            border-radius: 4px;
            cursor: pointer;
            color: white;
            border: none;
        }
        .chat-history-item:hover {
            background: #e56700;
        }
        .setting-item {
            margin: 15px 0;
        }
        .setting-item label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .setting-item select, .setting-item input {
            width: 100%;
            padding: 8px;
            border-radius: 5px;
            border: 2px solid black;
            background: black;
            color: white;
        }
        #resetChats {
            background: var(--one);
            color: white;
            border: 0px solid black;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }
        #resetChats:hover {
            background: #e56700;
        }
        
        /* Typing animation */
        .typing-dots {
            display: inline-block;
            animation: typing 1.5s infinite;
        }
        
        @keyframes typing {
            0%, 20% { opacity: 0; }
            50% { opacity: 1; }
            100% { opacity: 0; }
        }
        
        /* Rate dialog positioning */
        #rating {
            position: fixed;
            width: 90%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 0;
            border: none;
            background: transparent;
            z-index: 1002;
        }
        
        /* Bold text styling */
        .ai-message b {
            font-weight: bold;
            color: #ffcc00;
        }
        
        /* List styling */
        .ai-message ul, .ai-message ol {
            margin: 10px 0;
            padding-left: 20px;
        }
        
        .ai-message li {
            margin: 5px 0;
        }
        .ai-message a{
              text-decoration: none;
              font-weight: bold;
              color: cyan;
        }
        /* Messages container */
        #messagesContainer {
            padding-top: 0;
            margin-top: 0;
            min-height: calc(100vh - 130px);
            display: flex;
            flex-direction: column;
        }
        
        /* HTML code detection styling */
        .html-code-block {
            background: #111;
            border: 1px solid white;
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
            position: relative;
            font-family: monospace;
            overflow-x: auto;
            white-space: pre-wrap;
        }
    </style>
</head>
<body id="messageArea">
    <div id="header">
        <img src="gretta/logo.ico" id="grettaLogo" alt="‚òØ">
        <img onclick="openMenu()" src="gretta/bars.ico" id="bars" alt="=">
        <img src="gretta/add.ico" onclick="startNewChat()" id="newChatBtn">
        <script>
              function openMenu(){
 document.getElementById('menu').style.display='unset';
document.getElementById('newChatBtn').style.display='none';
              }
        </script>
        <div id="logo">‘ç Ä·¥á—Ç—Ç·¥Ä ·¥ÄŒπ</div>
    </div>

    <!-- Messages container -->
    <div id="messagesContainer"></div>

    <div id="inputArea">
        <div class="input-container">
            <textarea class="chat-input" id="chat-input" placeholder="ask me anything" rows="1"></textarea>
            <div class="input-actions">
                <button class="input-action-btn" id="speechToText" title="speak to me">
                   <img class="voice" src="gretta/voice.ico" alt="">
                </button>
            </div>
            <button class="send-btn" id="send-btn" style="display: none;">
                <span>€û</span>
            </button>
        </div>
    </div>
    <fieldset id="menu" style="background: white; width: 80%; color: white; position: fixed; top: 1.8em; right: 0; border: 5px solid black; border-right: none; border-radius: 1em 0 0 1em; display: none; height: 65vh; overflow-y: auto; z-index: 1001;">
        <legend id="menuActions">
            <table>
                <tr>
                    <td style="border-right: 5px solid black; padding: 0 1em;" id="chats1" onclick="showTab('chatsTab')">Chats</td>
                    <td style="padding: 0 1em;" onclick="showTab('settingsTab')">Settings</td>
    
                </tr>
            </table>
        </legend>
        <img onclick="closeMenu()" src="gretta/exit.ico" id="bars" alt="">
        <script>
       function closeMenu(){
 document.getElementById('menu').style.display='none';
document.getElementById('newChatBtn').style.display='unset';
              }
        </script>
        
        <!-- Chats Tab -->
        <div id="chatsTab">
            <div id="chatHistoryList"></div>

        </div>
        
        <!-- Settings Tab -->
        <div id="settingsTab" style="display: none;">
            <h3 style="color: black;">Settings</h3>
            <div class="setting-item">
                <label for="aiLanguage" style="color: black;">AI Language:</label>
                <select id="aiLanguage">
                    <option value="en">English</option>
                    <option value="es">Spanish</option>
                    <option value="fr">French</option>
                    <option value="de">German</option>
                    <option value="ja">Japanese</option>
                    <option value="zh">Chinese</option>
                </select>
            </div>
            <div class="setting-item">
                <label for="microphoneVolume" style="color: black;">Microphone Volume:</label>
                <input type="range" id="microphoneVolume" min="0" max="100" value="50">
            </div>
            <div class="setting-item">
                <button id="resetChats">Reset All Chats</button>
            </div>
        </div>
    </fieldset>

    <dialog id="rating" style="display: none;">
        <table>
            <tr>
                <th colspan="2" style="border-radius: 0.4em 0.4em 0 0; padding: 0 0.6em; background: var(--one); font-size: 1.3em;">How was your experience with us?</th>
            </tr>
            <tr>
                <td colspan="2" style="font-size: 3em; background: black; text-align: center;">
                    <span id="rate1" onclick="rate1()">‚òÜ</span>
                    <span id="rates1" onclick="rate1()">‚òÖ</span>
                    <span id="rate2" onclick="rate2()">‚òÜ</span>
                    <span id="rates2" onclick="rate2()">‚òÖ</span>
                    <span id="rate3" onclick="rate3()">‚òÜ</span>
                    <span id="rates3" onclick="rate3()">‚òÖ</span>
                    <span id="rate4" onclick="rate4()">‚òÜ</span>
                    <span id="rates4" onclick="rate4()">‚òÖ</span>
                    <span id="rate5" onclick="rate5()">‚òÜ</span>
                    <span id="rates5" onclick="rate5()">‚òÖ</span>
                </td>
            </tr>
            <tr>
                <th style="padding: 0.3em; border-radius: 0 0 0 0.4em; background: var(--one);" onclick="dismissRating()">Dismiss</th>
                <th onclick="rate()" style="border-radius: 0 0 0.4em 0; padding: 0 0.8em; background: var(--one);">Rate</th>
            </tr>
        </table>
    </dialog>
    <script>
                  const GEMINI_API_KEY = "AIzaSyCNBOGwau7S_gkpT-cT5PFEoew6GsyFD9g";
        const MODEL = "gemini-2.0-flash";
        
      
        const SYSTEM_PROMPT = `You are Gretta AI, an interactive coding assistant created by Golden Apple Technologies and powered by Google.
About you.
Name: Gretta AI Vol 1.
Creator: Icii White. <a href="mailto: goldenapplecoders@gmail.com">Email</a>.
Company: Golden Apple Technologies.
Sponsor: Google Inc
Contact: <a href="https://gretta.netlify.app/feedback">Gretta Feedback</a>
Whenever user asks for about you, your response should end with <i>Icii White üíù reigns</i>.
If user asks for an image, start the message with <img src="sorry.png" width="100%"><br>
If user asks for malicious or any unethical program information, start the message with <img src="sorry_hacker.png" width="100%"><br>
If user asks for abusive, offensive or pornographic information, start the message with <img src="sorry_red.png" width="100%"><br>.
If user asks for a code, start the message with <img src="toon_code.gif" width="100%"><br>, <img src="toon_code_alt.gif" width="100%"><br> or <img src="enjoy.png" width="100%"><br>(any of your choice. But keep choosing at random [from the 3(toon_code.gif, toon_code_alt.gif and enjoy.png)]).
If user types ".menu", this is what you should respond with."<i>Gretta Bot Only available on WhatsApp and Telegram.</a><br><a href="https://whatsapp.com/channel/0029Vb6e4V4EawdrM0DHTl3K">View Channel</a>"
You are designed to help users with coding, problem solving, and technical questions. 

Key characteristics:
- You are helpful, patient, and encouraging
- You provide clear, well-explained code examples
- You can help debug code and explain concepts
- You can generate images when requested (though you'll describe them since you can't actually generate images)
- You format code blocks properly with syntax highlighting
- You adapt to the user's experience level
- Your way of response is professional yet friendly and engaging

When responding:
1. For code, use markdown code blocks with the appropriate language
2. For complex concepts, break them down into simple steps
3. Ask clarifying questions when needed
4. Be concise but thorough
5. For any bold text in your response (not in the code block), use <b>bold text</b> tags instead of asterisks.(NEVER use asterisks or double asterisks in your response [unless it's in code block]).
6. For line breaks in your response, use <br> tags
7. For lists, use proper HTML list tags (<ul> and <li>)
8. Structure your responses professionally with proper formatting
9. Use a friendly and engaging tone while maintaining professionalism
10. IMPORTANT: When providing HTML code, always wrap it in markdown code blocks with the "html" language specifier
11.For tables in your response, use proper HTML table tags[not in code block] (<table>, <tr>, <td> and <td>)
Some information You Should keep in mind:
*Users usually ask for information that is not so popular. But you may not respond that you know nothing when a user asks about any WhatsApp bot.
if user wants to know about any WhatsApp bot but you have no idea(unless they want to create their own),
Display this list.
 <br>‚ïî‚ïê‚ïê <b>Whatsapp Bots Results</b> ‚ïê‚ïê‚ïó
 <li><a href="#">Gretta Bot</a></li>
 <li><a href="#">Queen Anita V5</a></li>
 <li><a href="#">Lady Mina</a></li>
 <li><a href="#">Sula MD</a></li>
 <li><a href="#">Nameless BOT</a></li>
 <li><a href="#">EmmyHenz V5</a></li>
 <li><a href="#">King Kira</a></li>
 <li><a href="#">Void XD 2025</a></li>    <br>‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê    <b>Verified</b> ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù<br>
12. If anyone types "hackmybot", just know its me, your coder. Welcome me as Icii White and feel free to tell me about what you may like to be modified on you for the better experience of users.
*This is everything about Icii White:
<img src="icii.png" width="100%">
His real name is <b>Mugenyi Bob Nathan</b>
Born on <b>22 September 2007</b>
<b>Ugandan</b> by Nationality,
<b>Full stack Developer</b>.
Github account : https://github.com/iciiwhite
Gitlab account: https://gitlab.com/iciiwhite/
contact: <a href="https://wa.me/+256700559067">Icii White üíù</a> and <a href="https://wa.me/+256791728084">Golden Apple Technologies</a>
Remember the conversation history to provide context-aware responses.`;

        // Chat state
        let chatHistory = [];
        let currentChatId = null;
        let isListening = false;
        let recognition = null;
        let hasShownRatingPrompt = false;
        let ratingPromptTimer = null;
        
        // DOM elements
        const messagesContainer = document.getElementById('messagesContainer');
        const chatInput = document.getElementById('chat-input');
        const sendBtn = document.getElementById('send-btn');
        const speechToTextBtn = document.getElementById('speechToText');
        const chatHistoryList = document.getElementById('chatHistoryList');
        
        // Initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            loadChatHistory();
            setupEventListeners();
            initializeSpeechRecognition();
            updatePlaceholder();
            
            // Check if we should show the rating prompt
            checkRatingPrompt();
            
            // Show new chat message if it's a new chat
            if (chatHistory.length === 0 && !currentChatId) {
                displayNewChatMessage();
            }
            
            // Scroll to bottom on initial load
            scrollToBottom();
        });
        
        // Setup event listeners
        function setupEventListeners() {
            sendBtn.addEventListener('click', sendMessage);
            
            // Enter key handling - only submit with Ctrl+Enter
            chatInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && e.ctrlKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            
            chatInput.addEventListener('input', function() {
                // Show/hide send button based on input
                if (chatInput.value.trim() === '') {
                    sendBtn.style.display = 'none';
                    speechToTextBtn.style.display = 'flex';
                } else {
                    sendBtn.style.display = 'flex';
                    speechToTextBtn.style.display = 'none';
                }
                
                // Remove new chat message when user starts typing
                if (chatHistory.length === 0 && chatInput.value.trim() !== '') {
                    removeNewChatMessage();
                }
            });
            
            // Reset chats button
            document.getElementById('resetChats').addEventListener('click', resetAllChats);
        }
        
        // Initialize speech recognition
        function initializeSpeechRecognition() {
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
                recognition.continuous = false;
                recognition.interimResults = false;
                recognition.lang = document.getElementById('aiLanguage').value;
                
                recognition.onstart = function() {
                    isListening = true;
                    speechToTextBtn.innerHTML = '<span class="fas fa-circle"></span>';
                    speechToTextBtn.style.color = 'red';
                };
                
                recognition.onresult = function(event) {
                    const transcript = event.results[0][0].transcript;
                    chatInput.value = transcript;
                    chatInput.dispatchEvent(new Event('input'));
                };
                
                recognition.onerror = function(event) {
                    console.error('Speech recognition error', event.error);
                    isListening = false;
                    resetSpeechButton();
                };
                
                recognition.onend = function() {
                    isListening = false;
                    resetSpeechButton();
                };
                
                speechToTextBtn.addEventListener('click', function() {
                    if (!isListening) {
                        recognition.lang = document.getElementById('aiLanguage').value;
                        recognition.start();
                    } else {
                        recognition.stop();
                    }
                });
            } else {
                speechToTextBtn.style.display = 'none';
                console.warn('Speech recognition not supported');
            }
        }
        
        function resetSpeechButton() {
            speechToTextBtn.innerHTML = '<img src="gretta/voice.ico" class="voice">';
            speechToTextBtn.style.color = 'white';
        }
        
        // Send message function
        async function sendMessage() {
            const message = chatInput.value.trim();
            if (!message) return;
            
            // Add user message to chat
            addMessageToChat('user', message);
            chatInput.value = '';
            sendBtn.style.display = 'none';
            speechToTextBtn.style.display = 'flex';
            
            // Update placeholder based on last message
            updatePlaceholder();
            
            // Save chat state
            saveChatState();
            
            // Show loading indicator with animated dots
            const loadingId = addMessageToChat('ai', '<span class="typing-dots">‚Ä¢‚Ä¢‚Ä¢</span>', true);
            
            try {
                // Prepare the conversation context
                const context = chatHistory.map(msg => ({
                    role: msg.role,
                    parts: [{ text: msg.content }]
                }));
                
                // Prepare the full prompt with system instructions
                const fullPrompt = `${SYSTEM_PROMPT}\n\nCurrent conversation:\n${context.slice(-10).map(msg => `${msg.role}: ${msg.parts[0].text}`).join('\n')}\n\nUser: ${message}`;
                
                // Call Gemini API
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${MODEL}:generateContent?key=${GEMINI_API_KEY}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        contents: [
                            {
                                parts: [
                                    { text: fullPrompt }
                                ]
                            }
                        ]
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`API request failed: ${response.status}`);
                }
                
                const data = await response.json();
                const aiResponse = data.candidates[0].content.parts[0].text;
                
                // Remove the temporary loading message
                deleteMessage(loadingId);
                
                // Add the actual AI response
                addMessageToChat('ai', aiResponse);
                
                // Start the rating prompt timer if it hasn't been shown yet
                if (!hasShownRatingPrompt && !sessionStorage.getItem('ratingDismissed')) {
                    startRatingPromptTimer();
                }
                
            } catch (error) {
                console.error('Error calling Gemini API:', error);
                // Remove the temporary loading message and show error
                deleteMessage(loadingId);
                addMessageToChat('ai', '<img src="error.png" alt="no_internet" width="100%"><br>Sorry, I could not process your request right now. Please try again.');
            }
            
            // Save chat state again after AI response
            saveChatState();
        }
        
        // Add message to chat
        function addMessageToChat(role, content, isTemp = false) {
            const messageId = 'msg_' + Date.now();
            const messageElement = document.createElement('div');
            messageElement.className = `message ${role}-message`;
            messageElement.id = messageId;
            
            if (role === 'ai') {
                // Process AI response for code blocks and images
                const processedContent = processAIResponse(content);
                messageElement.innerHTML = processedContent;
                
                // Add action buttons for AI messages
                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'message-actions';
                
                // Copy button
                const copyBtn = document.createElement('button');
                copyBtn.className = 'message-action-btn';
                copyBtn.innerHTML = '‚èç';
                copyBtn.title = 'Copy message';
                copyBtn.onclick = () => copyMessage(content);
                actionsDiv.appendChild(copyBtn);
                
                // Rate button
                const rateBtn = document.createElement('button');
                rateBtn.className = 'message-action-btn';
                rateBtn.innerHTML = '‚ô°';
                rateBtn.title = 'Rate response';
                rateBtn.onclick = () => showRatingDialog();
                actionsDiv.appendChild(rateBtn);
                
                // Delete button
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'message-action-btn';
                deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';
                deleteBtn.title = 'Delete message';
                deleteBtn.onclick = () => deleteMessage(messageId);
                actionsDiv.appendChild(deleteBtn);
                
                messageElement.appendChild(actionsDiv);
            } else {
                // User message
                messageElement.textContent = content;
                
                // Add action buttons for user messages (only delete button)
                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'message-actions';
                
                // Delete button
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'message-action-btn';
                deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';
                deleteBtn.title = 'Delete message';
                deleteBtn.onclick = () => deleteMessage(messageId);
                actionsDiv.appendChild(deleteBtn);
                
                messageElement.appendChild(actionsDiv);
            }
            
            messagesContainer.appendChild(messageElement);
            
            // Scroll to bottom after adding message
            scrollToBottom();
            
            // Add to chat history if not temporary
            if (!isTemp) {
                chatHistory.push({
                    id: messageId,
                    role: role,
                    content: content,
                    timestamp: Date.now()
                });
            } else {
                // For temporary messages, still add to chat history but mark as temporary
                // This ensures they can be found and deleted properly
                chatHistory.push({
                    id: messageId,
                    role: role,
                    content: content,
                    timestamp: Date.now(),
                    isTemp: true
                });
            }
            
            return messageId;
        }
        
        // Process AI response for code blocks and images
        function processAIResponse(content) {
            // Process code blocks first - only escape HTML inside code blocks
            let processed = content.replace(/```(\w+)?\n([\s\S]*?)```/g, function(match, lang, code) {
                const language = lang || 'text';
                // Escape HTML inside the code block
                const escapedCode = escapeHtml(code.trim());
                return `<div class="code-block">
                    <button class="copy-btn" onclick="copyCode(this)">Copy</button>
                    <pre><code class="language-${language}">${escapedCode}</code></pre>
                </div>`;
            });
            
            // Process inline code - escape HTML inside inline code
            processed = processed.replace(/`([^`]+)`/g, function(match, code) {
                return '<code>' + escapeHtml(code) + '</code>';
            });
            
            // Process image references (if any)
            processed = processed.replace(/\[Image: (.*?)\]/g, '<div><strong>Image:</strong> $1</div>');
            
            return processed;
        }
        
        // Escape HTML to prevent rendering
        function escapeHtml(unsafe) {
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }
        
        // Copy message to clipboard
        function copyMessage(content) {
            navigator.clipboard.writeText(content).then(() => {
                // Optional: Show a brief "copied" notification
                const originalText = chatInput.placeholder;
                chatInput.placeholder = 'Copied to clipboard!';
                setTimeout(() => {
                    chatInput.placeholder = originalText;
                }, 2000);
            });
        }
        
        // Copy code block to clipboard
        function copyCode(button) {
            const codeBlock = button.nextElementSibling;
            const codeText = codeBlock.textContent;
            navigator.clipboard.writeText(codeText).then(() => {
                button.textContent = 'Copied!';
                setTimeout(() => {
                    button.textContent = 'Copy';
                }, 2000);
            });
        }
        
        // Delete a message
        function deleteMessage(messageId) {
            // Remove from DOM
            const messageElement = document.getElementById(messageId);
            if (messageElement) {
                messageElement.remove();
            }
            
            // Remove from chat history
            const messageIndex = chatHistory.findIndex(msg => msg.id === messageId);
            if (messageIndex !== -1) {
                chatHistory.splice(messageIndex, 1);
                saveChatState();
            }
            
            // Scroll to bottom after deletion
            scrollToBottom();
        }
        
        // Update placeholder based on last user message
        function updatePlaceholder() {
            const userMessages = chatHistory.filter(msg => msg.role === 'user' && !msg.isTemp);
            if (userMessages.length > 0) {
                const lastMessage = userMessages[userMessages.length - 1].content;
                // Truncate if too long
                const truncated = lastMessage.length > 20 ? lastMessage.substring(0, 20) + '...' : lastMessage;
                chatInput.placeholder = truncated;
            } else {
                chatInput.placeholder = 'ask me anything';
            }
        }
        
        // Scroll to bottom of messages - This is the key fix
        function scrollToBottom() {
            // Force scroll to bottom immediately
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            // Double-check with a small delay to ensure it's at the bottom
            setTimeout(() => {
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }, 10);
        }
        
        // Save chat state to localStorage
        function saveChatState() {
            if (!currentChatId) {
                currentChatId = 'chat_' + Date.now();
            }
            
            // Filter out temporary messages before saving
            const messagesToSave = chatHistory.filter(msg => !msg.isTemp);
            
            const chatData = {
                id: currentChatId,
                history: messagesToSave,
                title: messagesToSave.length > 0 ? 
                    (messagesToSave[0].content.length > 30 ? 
                     messagesToSave[0].content.substring(0, 30) + '...' : 
                     messagesToSave[0].content) : 
                    'new chat',
                lastUpdated: Date.now()
            };
            
            // Get existing chats
            let chats = JSON.parse(localStorage.getItem('grettaChats') || '{}');
            chats[currentChatId] = chatData;
            localStorage.setItem('grettaChats', JSON.stringify(chats));
            
            // Update chat history list
            loadChatHistory();
        }
        
        // Load chat history from localStorage
        function loadChatHistory() {
            const chats = JSON.parse(localStorage.getItem('grettaChats') || '{}');
            chatHistoryList.innerHTML = '';
            
            // Sort chats by last updated (newest first)
            const sortedChats = Object.values(chats).sort((a, b) => b.lastUpdated - a.lastUpdated);
            
            if (sortedChats.length === 0) {
                chatHistoryList.innerHTML = '<p style="color: black;">No chat history yet.</p>';
                return;
            }
            
            sortedChats.forEach(chat => {
                const chatItem = document.createElement('div');
                chatItem.className = 'chat-history-item';
                chatItem.innerHTML = `
                    <strong>${chat.title}</strong>
                    <div style="font-size: 0.8em;">${new Date(chat.lastUpdated).toLocaleString()}</div>
                `;
                chatItem.onclick = () => loadChat(chat.id);
                chatHistoryList.appendChild(chatItem);
            });
        }
        
        // Load a specific chat
        function loadChat(chatId) {
            const chats = JSON.parse(localStorage.getItem('grettaChats') || '{}');
            const chat = chats[chatId];
            
            if (chat) {
                currentChatId = chatId;
                chatHistory = chat.history;
                
                // Clear messages container
                messagesContainer.innerHTML = '';
                
                // Reload messages
                chatHistory.forEach(msg => {
                    addMessageToChat(msg.role, msg.content);
                });
                
                // Update placeholder
                updatePlaceholder();
                
                // Close menu
                document.getElementById('menu').style.display = 'none';
                
                // Scroll to bottom after loading chat
                scrollToBottom();
            }
        }
        
        // Start a new chat
        function startNewChat() {
            currentChatId = null;
            chatHistory = [];
            
            // Clear messages container
            messagesContainer.innerHTML = '';
            
            // Show new chat message
            displayNewChatMessage();
            
            // Update placeholder
            updatePlaceholder();
            
            // Close menu
            document.getElementById('menu').style.display = 'none';
            
            // Save empty state
            saveChatState();
            
            // Scroll to bottom
            scrollToBottom();
        }
        
        // Display new chat message
        function displayNewChatMessage() {
            const messageElement = document.createElement('div');
            messageElement.className = 'message welcome-message';
            messageElement.textContent = 'New chat';
            messageElement.style.fontStyle = 'bold';
            messageElement.id = 'newChatMessage';
            messagesContainer.appendChild(messageElement);
            scrollToBottom();
        }
        
        // Remove new chat message
        function removeNewChatMessage() {
            const newChatMessage = document.getElementById('newChatMessage');
            if (newChatMessage) {
                newChatMessage.remove();
            }
        }
        
        // Reset all chats
        function resetAllChats() {
            if (confirm('Are you sure you want to reset all chats? This cannot be undone.')) {
                localStorage.removeItem('grettaChats');
                startNewChat();
                loadChatHistory();
            }
        }
        
        // Show tab in menu
        function showTab(tabId) {
            document.getElementById('chatsTab').style.display = 'none';
            document.getElementById('settingsTab').style.display = 'none';
            document.getElementById(tabId).style.display = 'block';
        }
        
        // Rating functions
        function showRatingDialog() {
            document.getElementById('rating').style.display = 'block';
        }
        
        function dismissRating() {
            document.getElementById('rating').style.display = 'none';
            // Save that user dismissed the rating
            sessionStorage.setItem('ratingDismissed', 'true');
        }
        
        function rate(){
            document.getElementById('rating').style.display = 'none'; 
            location.href='gretta/feedback.html';
        }
        
        function rate1(){                 
            document.getElementById('rate1').style.display = 'none';
            document.getElementById('rates1').style.display = 'unset';
            document.getElementById('rates2').style.display = 'none';
            document.getElementById('rates3').style.display = 'none';
            document.getElementById('rates4').style.display = 'none';
            document.getElementById('rates5').style.display = 'none';
            document.getElementById('rate2').style.display = 'unset';
            document.getElementById('rate3').style.display = 'unset';
            document.getElementById('rate4').style.display = 'unset';
            document.getElementById('rate5').style.display = 'unset';
        }
        
        function rate2(){
            document.getElementById('rate2').style.display = 'none';
            document.getElementById('rates2').style.display = 'unset';
            document.getElementById('rates1').style.display = 'unset';
            document.getElementById('rates3').style.display = 'none';
            document.getElementById('rates4').style.display = 'none';
            document.getElementById('rates5').style.display = 'none';
            document.getElementById('rate1').style.display = 'none';
            document.getElementById('rate3').style.display = 'unset';
            document.getElementById('rate4').style.display = 'unset';
            document.getElementById('rate5').style.display = 'unset';
        }
        
        function rate3(){
            document.getElementById('rate3').style.display = 'none';
            document.getElementById('rates3').style.display = 'unset';
            document.getElementById('rates2').style.display = 'unset';
            document.getElementById('rates1').style.display = 'unset';
            document.getElementById('rates4').style.display = 'none';
            document.getElementById('rates5').style.display = 'none';
            document.getElementById('rate2').style.display = 'none';
            document.getElementById('rate1').style.display = 'none';
            document.getElementById('rate4').style.display = 'unset';
            document.getElementById('rate5').style.display = 'unset';
        }
        
        function rate4(){
            document.getElementById('rate4').style.display = 'none';
            document.getElementById('rates4').style.display = 'unset';
            document.getElementById('rates2').style.display = 'unset';
            document.getElementById('rates3').style.display = 'unset';
            document.getElementById('rates1').style.display = 'unset';
            document.getElementById('rates5').style.display = 'none';
            document.getElementById('rate2').style.display = 'none';
            document.getElementById('rate3').style.display = 'none';
            document.getElementById('rate1').style.display = 'none';
            document.getElementById('rate5').style.display = 'unset';
        }
        
        function rate5(){
            document.getElementById('rate1').style.display = 'none';
            document.getElementById('rates1').style.display = 'unset';
            document.getElementById('rates2').style.display = 'unset';
            document.getElementById('rates3').style.display = 'unset';
            document.getElementById('rates4').style.display = 'unset';
            document.getElementById('rates5').style.display = 'unset';
            document.getElementById('rate2').style.display = 'none';
            document.getElementById('rate3').style.display = 'none';
            document.getElementById('rate4').style.display = 'none';
            document.getElementById('rate5').style.display = 'none';
        }
        
        // Rating prompt functionality
        function checkRatingPrompt() {
            // Check if user has already dismissed the rating
            if (sessionStorage.getItem('ratingDismissed')) {
                return;
            }
            
            // Check if there are previous chats
            const chats = JSON.parse(localStorage.getItem('grettaChats') || '{}');
            if (Object.keys(chats).length > 0) {
                // User has used the app before, start timer for rating prompt
                startRatingPromptTimer();
            }
        }
        
        function startRatingPromptTimer() {
            // Clear any existing timer
            if (ratingPromptTimer) {
                clearTimeout(ratingPromptTimer);
            }
            
            // Set timer for 5 minutes (300000 ms)
            ratingPromptTimer = setTimeout(() => {
                if (!hasShownRatingPrompt && !sessionStorage.getItem('ratingDismissed')) {
                    showRatingDialog();
                    hasShownRatingPrompt = true;
                }
            }, 300000); // 5 minutes
        }
    </script>
</body>
</html>
